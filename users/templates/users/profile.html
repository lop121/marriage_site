{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
    <div class="max-w-xl mx-auto bg-white/90 rounded-2xl shadow-lg p-8 mt-8">
        <h1 class="text-2xl font-bold text-pink-600 mb-6 text-center">–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <form method="post" enctype="multipart/form-data" class="space-y-5">
            {% csrf_token %}

            <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π –±–ª–æ–∫ –¥–ª—è —Ñ–æ—Ç–æ -->
            <div class="flex flex-col items-center mb-6">
                <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-pink-200 shadow mb-2">
                    <img id="avatarPreview"
                         src="{% if user.photo %}{{ user.photo.url }}{% else %}/media/users/default.png{% endif %}"
                         alt="–ê–≤–∞—Ç–∞—Ä"
                         class="object-cover w-full h-full">
                </div>
                <span class="text-pink-500 text-sm mb-2">–ò–∑–º–µ–Ω–∏ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å—Å—è!</span>
                <label class="cursor-pointer bg-pink-100 text-pink-700 px-4 py-2 rounded-lg shadow hover:bg-pink-200 transition mt-2">
                    –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ
                    <input type="file" name="photo" id="id_photo" accept="image/*" class="hidden">
                </label>
                {% if user.photo %}
                    <button type="button" id="deletePhotoBtn"
                            class="mt-2 bg-red-100 text-red-600 px-4 py-2 rounded-lg shadow hover:bg-red-200 transition">
                        –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
                    </button>
                {% endif %}
                {% if form.photo.errors %}
                    <div class="text-pink-500 text-xs mt-1">{{ form.photo.errors }}</div>
                {% endif %}
            </div>

            <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
            {% for f in form %}
                {% if f.name != "photo" %}
                    <div>
                        <label for="{{ f.id_for_label }}"
                               class="block text-pink-700 font-medium mb-1">{{ f.label }}</label>
                        {{ f|add_class:"w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" }}
                        {% if f.errors %}
                            <div class="text-pink-500 text-xs mt-1">{{ f.errors }}</div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <div class="mb-4">
                {% if is_married %}
                    <span class="inline-block bg-pink-100 text-pink-700 px-4 py-2 rounded-full font-semibold">
                    üíç –í –±—Ä–∞–∫–µ —Å {{ partner_name }}
                </span>
                {% else %}
                    <span class="inline-block bg-gray-100 text-gray-600 px-4 py-2 rounded-full font-semibold">
                    –ù–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –±—Ä–∞–∫–µ
                </span>
                {% endif %}
            </div>

            <div class="flex justify-center">
                <button type="submit"
                        class="bg-gradient-to-r from-pink-400 to-pink-300 text-white font-semibold px-8 py-2 rounded-xl shadow hover:scale-105 hover:from-pink-500 hover:to-pink-400 transition transform duration-200">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </form>

        {% if is_married %}
            <div class="mt-8 text-center">
                <button id="initiateDivorceBtn"
                        class="bg-pink-100 text-pink-700 font-semibold px-6 py-2 rounded-lg shadow hover:bg-pink-200 transition">
                    –†–∞–∑–≤–µ—Å—Ç–∏—Å—å
                </button>
                <div id="result" class="mt-4"></div>
                <div id="confirmationBlock" class="mt-4" style="display: none;">
                    <p class="mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–≤–µ—Å—Ç–∏—Å—å —Å {{ partner_name }}?</p>
                    <button id="confirmDivorceBtn"
                            class="bg-pink-500 text-white px-4 py-2 rounded-lg mr-2 hover:bg-pink-600 transition">–î–∞
                    </button>
                    <button id="cancelDivorceBtn"
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">–ù–µ—Ç
                    </button>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const initiateBtn = document.getElementById('initiateDivorceBtn');
            const confirmationBlock = document.getElementById('confirmationBlock');
            const confirmBtn = document.getElementById('confirmDivorceBtn');
            const cancelBtn = document.getElementById('cancelDivorceBtn');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            if (initiateBtn && confirmationBlock) {
                initiateBtn.addEventListener('click', function () {
                    initiateBtn.style.display = 'none';
                    confirmationBlock.style.display = 'block';
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
            if (cancelBtn && initiateBtn && confirmationBlock) {
                cancelBtn.addEventListener('click', function () {
                    initiateBtn.style.display = 'inline-block';
                    confirmationBlock.style.display = 'none';
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–∑–≤–æ–¥–∞
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async function () {
                    try {
                        const response = await fetch("{% url 'divorce-api' %}", {
                            method: 'PATCH',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json',
                            },
                        });

                        const data = await response.json();

                        if (response.ok) {
                            document.getElementById('result').innerHTML = '<p class="text-green-600">' + (data.detail || "–ë—Ä–∞–∫ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç") + '</p>';
                            setTimeout(() => {
                                window.location.href = "{% url 'profile' %}";
                            }, 2000);
                        } else {
                            document.getElementById('result').innerHTML = '<p class="text-red-600">–û—à–∏–±–∫–∞: ' + (data.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç—å –±—Ä–∞–∫") + '</p>';
                            if (initiateBtn && confirmationBlock) {
                                initiateBtn.style.display = 'inline-block';
                                confirmationBlock.style.display = 'none';
                            }
                        }
                    } catch (error) {
                        document.getElementById('result').innerHTML = '<p class="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error + '</p>';
                        if (initiateBtn && confirmationBlock) {
                            initiateBtn.style.display = 'inline-block';
                            confirmationBlock.style.display = 'none';
                        }
                    }
                });
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const deleteBtn = document.getElementById('deletePhotoBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async function () {
                    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ?')) return;
                    try {
                        const response = await fetch("{% url 'delete_photo' %}", {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json',
                            },
                        });
                        if (response.ok) {
                            document.getElementById('avatarPreview').src = '/media/users/default.png';
                            deleteBtn.style.display = 'none';
                        } else {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
                        }
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
                    }
                });
            }
        });
    </script>
    <script>
        document.getElementById('id_photo').addEventListener('change', function (event) {
            const [file] = event.target.files;
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    </script>
{% endblock %}