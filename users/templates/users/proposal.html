{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white/90 rounded-2xl shadow-lg p-8 mt-8">
    {% if is_for_registered %}
        <h1 class="text-2xl font-bold text-pink-600 mb-4 text-center">Для зарегистрированных пользователей</h1>
        <hr class="mb-6 border-pink-200">
        <h2 class="text-lg font-semibold text-pink-500 mb-2">Список свободных:</h2>
        <ul class="mb-8 space-y-2">
            {% for user in free_users %}
                <li class="flex items-center gap-3 bg-pink-50 rounded px-4 py-2 text-pink-700 shadow-sm">
                    <a href="{% url 'public_profile' user.pk %}" class="flex items-center gap-2 group">
                        <img src="{% if user.photo %}{{ user.photo.url }}{% else %}/media/users/default.png{% endif %}"
                             alt="Аватар"
                             class="w-8 h-8 rounded-full border-2 border-pink-200 object-cover group-hover:border-pink-400 transition">
                        <span class="font-semibold group-hover:underline">{{ user.get_full_name }}</span>
                    </a>
                </li>
            {% empty %}
                <li class="text-gray-400">Нет свободных пользователей</li>
            {% endfor %}
        </ul>
    {% else %}
        <h1 class="text-2xl font-bold text-pink-600 mb-4 text-center">Для незарегистрированных пользователей</h1>
        <hr class="mb-6 border-pink-200">
    {% endif %}

    <h2 class="text-xl font-bold text-pink-500 mb-4 text-center">Отправить предложение</h2>
    <form id="proposal-form" method="post" class="space-y-6">
        {% csrf_token %}
        {{ form.type }}

        {% if is_for_registered %}
            <div class="relative mb-4">
                <label class="block text-pink-700 font-medium mb-1">Имя или фамилия пользователя:</label>
                <input type="hidden" name="receiver_username" id="receiver-username-hidden">
                <input type="text" id="user-autocomplete" autocomplete="off"
                       placeholder="Начните вводить имя или фамилию..."
                       class="w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                <div id="autocomplete-list"
                     class="absolute left-0 right-0 bg-white border border-pink-200 rounded-b-lg shadow z-10"></div>
            </div>
        {% else %}
            <div>
                <label class="block text-pink-700 font-medium mb-1">Имя (для нового пользователя):</label>
                {{ form.first_name|add_class:"w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" }}
                {% if form.first_name.errors %}
                    <div class="text-pink-500 text-xs mt-1">{{ form.first_name.errors }}</div>
                {% endif %}
            </div>
            <div>
                <label class="block text-pink-700 font-medium mb-1">Фамилия (для нового пользователя):</label>
                {{ form.last_name|add_class:"w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" }}
                {% if form.last_name.errors %}
                    <div class="text-pink-500 text-xs mt-1">{{ form.last_name.errors }}</div>
                {% endif %}
            </div>
            <div>
                <label class="block text-pink-700 font-medium mb-1">Пол (для нового пользователя):</label>
                {{ form.gender|add_class:"w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" }}
                {% if form.gender.errors %}
                    <div class="text-pink-500 text-xs mt-1">{{ form.gender.errors }}</div>
                {% endif %}
            </div>
        {% endif %}

        <div class="flex justify-center">
            <button type="submit"
                class="bg-gradient-to-r from-pink-400 to-pink-300 text-white font-semibold px-8 py-2 rounded-xl shadow hover:scale-105 hover:from-pink-500 hover:to-pink-400 transition transform duration-200">
                Отправить
            </button>
        </div>
    </form>

    <div id="result" class="mt-4 text-center"></div>
</div>

<script>
const input = document.getElementById('user-autocomplete');
const list = document.getElementById('autocomplete-list');
const hiddenInput = document.getElementById('receiver-username-hidden');

if (input) {
    input.addEventListener('input', function() {
        const query = this.value;
        if (query.length < 2) {
            list.innerHTML = '';
            return;
        }
        fetch(`/api/users/autocomplete/?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(users => {
                list.innerHTML = '';
                users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = "flex items-center gap-2 px-4 py-2 cursor-pointer hover:bg-pink-100";
                    item.innerHTML = `
                        <img src="${user.photo ? user.photo : '/media/users/default.png'}"
                             alt="Аватар"
                             class="w-7 h-7 rounded-full border-2 border-pink-200 object-cover">
                        <span class="font-semibold">${user.first_name} ${user.last_name}</span>
                    `;
                    item.addEventListener('click', function() {
                        input.value = `${user.first_name} ${user.last_name}`;
                        hiddenInput.value = user.username;
                        list.innerHTML = '';
                    });
                    list.appendChild(item);
                });
            });
    });

    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !list.contains(e.target)) {
            list.innerHTML = '';
        }
    });
}
</script>

<script>
document.getElementById('proposal-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);

    fetch('/api/proposal/', {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('result').innerHTML = '<p class="text-green-600">' + data.message + '</p>';
        const proposalType = document.querySelector('input[name="type"]').value || 'registered';
        setTimeout(() => window.location.href = `/proposal/?type=${proposalType}`, 2000);
    })
    .catch(error => {
        let errorMsg = 'Ошибка: ';
        if (Array.isArray(error)) {
            // Просто массив ошибок
            errorMsg += error.join(', ');
        } else if (typeof error === 'object' && error !== null) {
            // Объект с полями ошибок
            for (let key in error) {
                let errs = error[key];
                if (Array.isArray(errs)) {
                    errs = errs.flat();
                    errorMsg += errs.join(', ') + ' ';
                } else {
                    errorMsg += errs + ' ';
                }
            }
        } else {
            errorMsg += error;
        }
        document.getElementById('result').innerHTML = '<p class="text-red-600">' + errorMsg.trim() + '</p>';
    });
});
</script>
{% endblock %}