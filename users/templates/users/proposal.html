{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white/90 rounded-2xl shadow-lg p-8 mt-8">
    {% if is_for_registered %}
        <h1 class="text-2xl font-bold text-pink-600 mb-4 text-center">Для зарегистрированных пользователей</h1>
        <hr class="mb-6 border-pink-200">
        <h2 class="text-lg font-semibold text-pink-500 mb-2">Список свободных:</h2>
        <ul class="mb-8 space-y-2">
            {% for user in free_users %}
                <li class="bg-pink-50 rounded px-4 py-2 text-pink-700 shadow-sm">
                    {{ user.get_full_name }} <span class="text-gray-400 text-sm">(Login: {{ user.username }})</span>
                </li>
            {% empty %}
                <li class="text-gray-400">Нет свободных пользователей</li>
            {% endfor %}
        </ul>
    {% else %}
        <h1 class="text-2xl font-bold text-pink-600 mb-4 text-center">Для незарегистрированных пользователей</h1>
        <hr class="mb-6 border-pink-200">
    {% endif %}

    <h2 class="text-xl font-bold text-pink-500 mb-4 text-center">Отправить предложение</h2>
    {% if not is_for_registered %}
        <p class="text-sm text-pink-600 bg-pink-50 rounded-lg px-4 py-2 text-center mt-2 shadow-sm">
            На данный момент заявки не проверяются модерацией и сразу подписываются районным ЗАГСом.<br>
            Будьте вежливы и без политики на сайте!
        </p>
    {% endif %}
    <form id="proposal-form" method="post" class="space-y-6">
        {% csrf_token %}
        {{ form.type }}

        {% if is_for_registered %}
            <div class="relative mb-4">
                <label class="block text-pink-700 font-medium mb-1">Имя или фамилия пользователя:</label>
                <input type="hidden" name="receiver_username" id="receiver-username-hidden">
                <input type="text" id="user-autocomplete" autocomplete="off"
                       placeholder="Начните вводить имя или фамилию..."
                       class="w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                <div id="autocomplete-list"
                     class="absolute left-0 right-0 bg-white border border-pink-200 rounded-b-lg shadow z-10"></div>
            </div>
        {% else %}
            <div>
                <label class="block text-pink-700 font-medium mb-1">Имя (для нового пользователя):</label>
                {{ form.first_name|add_class:"w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" }}
                {% if form.first_name.errors %}
                    <div class="text-pink-500 text-xs mt-1">{{ form.first_name.errors }}</div>
                {% endif %}
            </div>
            <div>
                <label class="block text-pink-700 font-medium mb-1">Фамилия (для нового пользователя):</label>
                {{ form.last_name|add_class:"w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" }}
                {% if form.last_name.errors %}
                    <div class="text-pink-500 text-xs mt-1">{{ form.last_name.errors }}</div>
                {% endif %}
            </div>
            <div>
                <label class="block text-pink-700 font-medium mb-1">Пол (для нового пользователя):</label>
                {{ form.gender|add_class:"w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" }}
                {% if form.gender.errors %}
                    <div class="text-pink-500 text-xs mt-1">{{ form.gender.errors }}</div>
                {% endif %}
            </div>
        {% endif %}

        <div class="flex justify-center">
            <button type="submit"
                class="bg-gradient-to-r from-pink-400 to-pink-300 text-white font-semibold px-8 py-2 rounded-xl shadow hover:scale-105 hover:from-pink-500 hover:to-pink-400 transition transform duration-200">
                Сделать предложение!
            </button>
        </div>
    </form>

    <div id="result" class="mt-4 text-center"></div>
</div>

<script>
document.getElementById('proposal-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);

    fetch('/api/proposal/', {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('result').innerHTML = '<p class="text-green-600">' + data.message + '</p>';
        const proposalType = document.querySelector('input[name="type"]').value || 'registered';
        setTimeout(() => window.location.href = `/proposal/?type=${proposalType}`, 2000);
    })
    .catch(error => {
        let errorMsg = 'Ошибка: ';
        if (error.non_field_errors) {
            errorMsg += error.non_field_errors.join(', ');
        } else if (error.receiver_username) {
            errorMsg += error.receiver_username.join(', ');
        } else {
            errorMsg += JSON.stringify(error);
        }
        document.getElementById('result').innerHTML = '<p class="text-red-600">' + errorMsg + '</p>';
    });
});
</script>

<script>
const input = document.getElementById('user-autocomplete');
const list = document.getElementById('autocomplete-list');
const hiddenInput = document.getElementById('receiver-username-hidden');

if (input) {
    input.addEventListener('input', function() {
        const query = this.value;
        if (query.length < 2) {
            list.innerHTML = '';
            return;
        }
        fetch(`/api/users/autocomplete/?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(users => {
                list.innerHTML = '';
                users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = "px-4 py-2 cursor-pointer hover:bg-pink-100";
                    item.innerHTML = `<b>${user.first_name} ${user.last_name}</b> <small>(${user.username})</small>`;
                    item.addEventListener('click', function() {
                        input.value = `${user.first_name} ${user.last_name} (${user.username})`;
                        hiddenInput.value = user.username;
                        list.innerHTML = '';
                    });
                    list.appendChild(item);
                });
            });
    });

    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !list.contains(e.target)) {
            list.innerHTML = '';
        }
    });
}
</script>
{% endblock %}